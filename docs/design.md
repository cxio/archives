# 开放存档服务（Archives）

这是一个通用的存档服务，存储的目标为任意类型的文档数据。文档的大小是任意的。

存储采用本地文件系统，服务器为P2P数据分享客户端。这并不是大型服务器即时数据供给的模式，它是一种长期存储，配合数据驿站（depots）使用。

> **注：**
> 主要用于存档区块链交易里的附件，因为交易里只是一个ID。



## 数据流

较大的存档文件通常不适合以“服务器/客户端”的模式获取，而是像 `BitTorrent` 文件分享一样，通过P2P的方式流动。

```go
询问者（Client） <==> 驿站 <====> 数据网络 <====> 驿站（+ Archives）
        |                                                 |
        |                P2P data-transfer                |
        <-------------------------------------------------+
```

数据驿站有一个监听服务，接受询问者（Client）的连入，查询数据。查询请求会在驿站节点组成的网络中传播……

每一个驿站节点会检查自己是否拥有目标数据，如果没有，即时转播消息。如果有，则向Archives应用（服务器）寻求确认：

- 确实有：Archives返回自身或远端中转节点的地址，地址信息通过原询问路径回传。
- 已丢失：Archives返回错误，表示数据未找到，驿站会标记该数据已丢失。同时会根据存储策略，决定是否补充存储。

> **补充存储：**
> 驿站自己向网络发送请求，当获得回应地址后，交由Archives去完成存储。

当询问者通过回传的消息获得数据源的地址后，即可创建P2P连接，获取实际的数据。

询问者通常会自己开启一个驿站App，该App连入数据网络，向多个相连的节点发送询问。因此通常会获得多个回应，从而创建有效的P2P连接。

> **注记：**
> 驿站有一个*询问者*模式，该模式下会收集多个回应暂存，而不是转播后就丢弃。


### 数据的存在性

每一个数据源的驿站在启动初期，即会构造一个数据ID的缓存器（如布隆过滤器），当询问者的请求到达时，驿站会在内部先判断数据的有无。如果存在，则向相连的Archives发送具体的请求。

Archives会进一步判断数据是否存在，存在则返回自身（或远端中转）节点的地址。否则返回错误，驿站会标记该数据为丢失。根据存储策略，丢失的数据可能会重新请求以补充存储。

在这种 **驿站 + Archives** 的结构中，驿站是主导的，存储策略在驿站中配置。Archives是从动的，听从驿站的调动指挥。如果驿站决定补充存储某个数据，则此时的Archives就充当询问者的角色了。



## 文档元信息

存档的数据除了文档本身外，通常还有一个元信息文件，包含了对文档基本信息的记录。如：类型、概要、大小、时间戳等。不同的类型通常会有不同的具体条目。


### 共有条目

- 文件：文档文件名，含扩展名
- 类型：MIME 类型，如：image/svg+xml
- 标题：文档的名称。
- 概要：文档的内容摘要、大纲。
- 大小：文档大小（字节数），通常自动计算。
- 语言：文档内容所属语种，可多语种并列。
- 上传者：可能是作者。
- 作者：文档的原始作者，多位并列。
- 创建时间：文档原始创建时的时间。
- 版权：文档的原版权声明，可选。公共域内容可能无版权。
- 指纹：文档数据的哈希。
- 附加：文档自身特有的元信息（Extra），由`JSON`配置定义。
- 关联：文档附带的关联信息（文件名列表）。

> **注**：类型参考 HTML 的 MIME 定义。


### 存档路径：

文档内容的哈希摘要称为文档ID，下面简写为 `DID`。

四层目录结构，末端为文档ID，前段为文档ID的*逐字节*分层。目录/文件名示意如下：

```go
[DID:FF]/                               // 一级：文档ID首字节16进制表达，大写
    [DID:0xff]/                         // 二级：ID次字节16进制表达，小写，前置0x
        [DID:255]/                      // 三级：ID第三字节16进制表达，3位十进制
            [DID]/                      // 文档目录，ID序列（32字节）
                [file].xxx              // 文档文件，名称与meta内的相同
                _meta.json              // 文档元信息，JSON格式便于提取条目
                ...                     // 其它可能附带的关联数据
            _list.txt                   // 可选。各文档 "ID:Title|File" 对应清单（人工友好）
```

三级256分层（不含末端）最多可以离散16M区隔，基本可以适用个人普通主机了（子目录内不会包含太多条目）。


### 固化存储

通常来说，存档不可修改，甚至删除都不应该有，所以长期保存是其基本逻辑。这能带来一些优点：

- 便于优化，提高存储和检索效率。
- 单次只写易于采用廉价存储介质，便于大规模存档。
- 安全上除了物理破坏，不存在数据误操作的可能。



## 存储激励

如果节点存储的是区块链里的附件，由于区块链可以提供代币回报，所以此时的存储是有动机的。

但对于非区块链类应用，存储的动力可能就有问题了。

文件分享式的P2P存储有些近似于公共域逻辑，版权保护是一个问题。但如果有大量开放版权的文档，或者采用数据网存储的文档大部分都为开放版权。出于对数据价值的挖掘，或许存储动机就不是一个太大的问题。如果未来甚至形成了某种良好的数据生态……应该就没有这个问题了。


### 存储应用

在手机拍摄便捷的自媒体时代，很多人的数据其实是愿意分享的。如果有一个数据分享应用：

- 把自己的数据交给别人保存。因为是随机的冗余式存储，所以很难丢失。
- 自己存储别人的数据。因为是别人的，所以其实没那么在意是否丢失。心态是轻松点，但随机冗余提供了保障。

这或许是一个不错的存储分享应用，我为人人，人人为我。



## 区块链支持

### 获取

- **区块**：从区块链校验组那里获取完整的区块数据。
- **附件**：从交易的构造者那里获取交易包含的附件数据。


### 供给

向刚上线的查询服务器、或任何普通钱包用户、以及第三方应用等提供区块、附件和其它数据。

- **区块**：从 `区块号 | 区块ID` 检索。获取一个区块的完整数据。
- **附件**：从 `附件ID` 检索。通常用于较大尺寸的附件，如2MB以上。
- **区块头链**：从 `创始块ID` 检索。主要由初始上线节点下载此基准数据。
- **UTXO集**：从 `创始块ID` 检索。主要为新上线的校验组初始化UTXO缓存。
- **关联交易**：从 `账户地址` 检索。普通用户查找自身账户关联交易集。
